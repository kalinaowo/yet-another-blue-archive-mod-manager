<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">
        <style>
            #topBar {
                position: relative;
                width: 99%;
                height: 7%;
                background-color: #1b1b1b;
                border-radius: 23px;
                color:#a8c1fa;
                top:1vh
            }
            #titleText {
                position: relative;
                top:1vh;
                left:1.5vw;
                font-size: 3.5vh;
            }
            #buttonsDiv {
                position: relative;
                background-color: #1b1b1b;
                border-radius: 23px;
                top:4%;
                left:1vw;
                height: 41.5%;
                width: 33%;
                padding:1%;
            }
            #logsDiv {
                position: relative;
                background-color: #1b1b1b;
                border-radius: 23px;
                top:8vh;
                left:1vw;
                height: 37.5%;
                width: 33%;
                padding:1%;
                color: #a8c1fa;
                overflow-y: auto; 
            }
            #mainModListDiv {
                position: relative;
                background-color: #1b1b1b;
                border-radius: 23px;
                bottom:77.5vh;
                height: 85.3%;
                width: 56.5%;
                left:40%;
                padding:1%;
                color: #a8c1fa;
                overflow-y: auto; 
            }
            .dragover {
                border: 0.4vw solid #a8c1fa;
            }
            .styled-scrollbars {
                scrollbar-color: transparent transparent;
                scrollbar-width: thin;
                --scrollbar-background: var(--styled-scrollbar-background, var(--shreddit-content-background));
            }
            .modFolderInput {
                background-color: #282a2c;
                border: none;
                border-radius: 20px;
                top:2vh;
                left:1vw;
                position: relative;
                width: 70%;
                height:4.4vh;
                color: #a8c1fa;
                font-family: "Outfit", sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-style: normal;
            }
            button {
                border-radius: 20px;
                border: 0.4vw solid #a8c1fa;
                color: #a8c1fa;
                background-color: #282a2c;
                font-family: "Outfit", sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-style: normal;
                transition: all 0.3s ease;
            }
            button:hover {
                background-color: #454f5a;
            }
            #openButton {
                position: relative;
                width:22%;
                height:4.4vh;
                top:2vh;
                left:1.5vw;
                font-size: 1.3vw;
            }
            body {
                overflow: hidden;
                background-color: #131314;
                font-family: "Outfit", sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-style: normal;
            }
            input:focus {
                outline: none;
            }
            #line {
                width:100%;
                height: 0.7vh;
                background-color: #202020;
                border-radius: 20px;
                top:6vh;
                position: relative;
            }
            #loadedText {
                text-align: center;
                color:#a8c1fa;
                font-size: 3.3vh;
                position: relative;
                top:4vh;
            }
            .modDiv {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 93%;          
                margin: 10px auto;  
                padding: 10px 15px;
                border-radius: 20px;
                background-color: #282a2c;
            }

            .modP {
                font-size: 2vh;
                margin: 0;
                color:#a8c1fa;
            }

            .modButtons {
                display: flex;
                gap: 10px;
            }

            .modB {
                border-radius: 20px;
                border: 0.4vw solid #a8c1fa;
                color: #a8c1fa;
                background-color: #282a2c;
                font-family: "Outfit", sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-style: normal;
            }
            .modT {
                color: #a8c1fa;
                font-family: "Outfit", sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-style: normal;
                margin: 0px;
                position: relative;
                top:0.3vh;
            }
            #nameChanger {
                position: absolute;
                transform: translate(-55%, -100%);
                width: 30%;
                background-color: #131314;
                border-radius: 20px;
                border: 0.5vw solid #a8c1fa;
                padding: 1.5vh 1.5vw;
                display: flex;   
                flex-direction: column; 
                align-items: center;
                padding: 2vh 0;
            }
            #nameChanger button {
                position: static;
                top: initial;
                left: initial;
                margin: 1vh 0;
                font-size: 2vw;
            }

            .modal-button-row {
                display: flex;
                justify-content: space-around; 
                align-items: center;
                width: 90%;
                margin: 1.5vh auto;
            }

            #dim3 .modal-button-row button {
                width: 20%; 
                height: 4vh; 
                font-size: 1.7vw; 
                font-weight: 600;
            }
            #dim3 .modal-button-row:last-child button {
                width: 40%;
            }
            .dim {
                position: absolute;
                width:150%;
                height:150%;
                top:0%;
                left:0%;
                background-color: rgb(0,0,0,0.4);
                display: flex;
                justify-content: center;
                align-items: center;
            }
            .nameChangeText {
                color: #a8c1fa;
                font-size: 2vw;
                width: 90%; 
                text-align: center; 
            }
            #nameChangeInput {
                background-color: #282a2c;
                border: none;
                border-radius: 20px;
                top:2vh;
                left:2vw;
                position: relative;
                width: 90%;
                height:4.4vh;
                color: #a8c1fa;
                font-family: "Outfit", sans-serif;
                font-optical-sizing: auto;
                font-weight: 400;
                font-style: normal;
            }
            #nameChanger button {
                position: static !important;
                top: initial !important;
                margin: 0 0.5vw;
            }

            .settings-group {
                width: 90%;
                margin: 2vh 0;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .input-button-row {
                display: flex;
                align-items: center; 
                justify-content: space-between; 
                width: 94%; 
                margin: 1vh auto; 
            }

            #gameDirInput {
                height: 4vh; 
                flex-grow: 1; 
                flex-basis: 70%;
                margin-right: 1.5vw; 
                position: static !important; 
                top: initial !important; 
            }

            .input-button-row button {
                height: 4vh;
                flex-shrink: 0;
                width: 20%;
                position: static !important;
                top: initial !important;
            }

            .button-row {
                display: flex;
                justify-content: space-around;
                align-items: center;
                width: 100%;
                margin: 1vh 0;
            }

            .button-row button {
                height: 4vh; 
                font-size: 1.7vw; 
                font-weight: 600;
            }
            .button-row:first-child button {
                width: 45%; 
            }
            .button-row:nth-child(2) button {
                width: 50%; 
            }

            .close-group button {
                width: 20%; 
            }

            #gameDirInput {
                flex-grow: 1; 
                margin-right: 1vw;
            }

            #nameChangeInput {
                position: static !important; 
                top: initial !important; 
                
                width: 90%;
                margin-bottom: 3vh;
                height: 4.4vh;
            }
            .rename-buttons {
                display: flex;
                justify-content: space-around;
                align-items: center;
                width: 50%;
                margin-top: 2vh;
            }

            .rename-buttons button {
                position: static !important;
                top: initial !important;
                height: 5vh;
                width: auto;
                font-size: clamp(15px, 1.7vw, 28px) !important;
                font-weight: 600;
                margin: 0 1vw; 
            }

        </style>
        <script>
            // a8c1fa, 
            let currentMod = null;
            let allowModCopying = false;
            let modLength = 0;
            let realModName = null;
            let defaultModName = "mod\\";

            async function loadUserMods() {
                let response = await window.pywebview.api.loadMod(document.getElementById("modFolderInput").value);
                document.getElementById("loadedText").innerText = response;
                if(response.startsWith("Mods")) {
                    allowModCopying = true;
                }
            }
            async function defaultLoadUserMods() {
                let response = await window.pywebview.api.loadMod(defaultModName);
                document.getElementById("loadedText").innerText = response;
                if(response.startsWith("Mods")) {
                    allowModCopying = true;
                }
            }
            async function displayAllMods(modList) {
                document.getElementById("mainModListDiv").innerHTML = "";
                for(i = 0; i < modList.length; i++) {
                    createModEntry(modList[i], i);
                }
                modLength = modList.length;
            }
            async function selectFolder() {
                let response = await window.pywebview.api.openFilePicker();
                document.getElementById("modFolderInput").value = response;
            }
            async function selectFolderGameDir() {
                let response = await window.pywebview.api.openFilePicker();
                document.getElementById("gameDirInput").value = response;
            }
            function addLog(msg) {
                let newLog = document.createElement("p");
                newLog.innerHTML = msg;
                document.getElementById("logsDiv").appendChild(newLog);
                document.getElementById("logsDiv").scrollTop = document.getElementById("logsDiv").scrollHeight;
            }
            function openRenameMenu(id) {
                currentMod = id;
                document.getElementById("dim").style.display = "flex";
            }
            async function applyModChange() {
                document.getElementById("modTextID"+currentMod).textContent = document.getElementById("nameChangeInput").value;
                document.getElementById("characterNameText").textContent = document.getElementById("nameChangeInput").value;
                let response = await window.pywebview.api.changeModName(document.getElementById("nameChangeInput").value,currentMod);
            }
            async function reset() {
                deleteModName();
                closeProperties();
            }
            async function deleteMod() {
                if (currentMod == null) {
                    return;
                }
                let response = await window.pywebview.api.deleteMod(currentMod);
                closeProperties();
            }
            async function patchCRC() {
                if (currentMod == null) {
                    return;
                }
                let response = await window.pywebview.api.patchCRC(currentMod);
                closeProperties();
            }
            async function updateMod() {
                if (currentMod == null) {
                    return;
                }
                let response = await window.pywebview.api.updateMod(currentMod);
                closeProperties();
            }
            function toggleModButton(id) {
                if (document.getElementById("modButtonID"+id).textContent == "||On||") {
                    document.getElementById("modButtonID"+id).textContent = "||Off||";
                }
                else {
                    document.getElementById("modButtonID"+id).textContent = "||On||";
                }

            }
            function cancelRenameMod() {
                document.getElementById("nameChangeInput").value = "";
                document.getElementById("dim").style.display = "none";
            }
            function createModEntry(modName, id) {
                let newModDiv = document.createElement("div");
                newModDiv.className = "modDiv"; 
                newModDiv.id = "modDivID"+id;

                let modText = document.createElement("p");
                modText.className = "modP";
                modText.textContent = modName; 
                modText.id = "modTextID"+id;

                let modButtons = document.createElement("div");
                modButtons.className = "modButtons";

                let propertiesButton = document.createElement("button");
                propertiesButton.className = "modB";
                propertiesButton.textContent = "||Properties||";
                propertiesButton.onclick = function() {
                    openPropertiesMenu(id);
                };

                let applyModButton = document.createElement("button");
                applyModButton.className = "modB";
                applyModButton.textContent = "||On||";
                applyModButton.id = "modButtonID"+id;
                applyModButton.onclick = function() {
                    toggleModButton(id);
                };
                let modStatusText = document.createElement("p");
                modStatusText.className = "modT";
                modStatusText.textContent = "";
                modStatusText.id = "modStatusID"+id;

                modButtons.appendChild(modStatusText)
                modButtons.appendChild(applyModButton);
                modButtons.appendChild(propertiesButton);

                newModDiv.appendChild(modText);
                newModDiv.appendChild(modButtons);

                document.getElementById("mainModListDiv").appendChild(newModDiv);

            }
            function closeProperties() {
                currentMod = null;
                document.getElementById("dim2").style.display = "none";
            }
            async function openPropertiesMenu(id) {
                let modDetails = await window.pywebview.api.getModDetails(id);
                document.getElementById("characterNameText").textContent = modDetails[0].toString();
                document.getElementById("realCharacterNameText").textContent = "||Character: ||" + modDetails[1].toString();
                document.getElementById("isPrologdepengroupText").textContent = "||Is Applied: ||" + modDetails[2].toString();
                currentMod = id
                realModName = modDetails[1].toString();
                document.getElementById("dim2").style.display = "flex";
            }
            window.onload = function() {
                const dropzone = document.getElementsByClassName("dropzone")[0];
                dropzone.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    dropzone.classList.add("dragover");
                });

                dropzone.addEventListener("dragleave", () => {
                    dropzone.classList.remove("dragover");
                });

                dropzone.addEventListener("drop", async (e) => {
                    if(!allowModCopying) {
                        addLog("||Please select a valid path before copying files!||")
                        return;
                    }
                    e.preventDefault();
                    dropzone.classList.remove("dragover");

                    let filesToSend = [];
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            const data = await convertToBase64(files[i]);
                            filesToSend.push({"name": files[i].name, "data": data});
                        }
                    }
                    sendFileData(filesToSend);
                });
            };
            function convertToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader(); 
                    reader.onload = (event) => {
                        const base64String = event.target.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = (error) => reject(error);
                    reader.readAsDataURL(file);
                });
            }

            async function sendFileData(recievedFiles) {
                await window.pywebview.api.recieveFileData(recievedFiles);
            }
            async function applyUserMods() {
                buttonStates = []
                for(let i = 0; i < modLength; i++) {
                    buttonStates.push(document.getElementById("modButtonID"+i).innerHTML);
                }
                let response = await window.pywebview.api.applyMod(buttonStates);
                i2 = 0
                for(let i = 0; i < response.length;) {
                    if(buttonStates[i+i2] == "||On||") {
                        document.getElementById("modStatusID" + (i+i2)).textContent = response[i];
                        i++;
                    }
                    else {
                        i2++;
                    }
                }
            }
            async function restoreUserMods() {
                buttonStates = []
                for(let i = 0; i < modLength; i++) {
                    buttonStates.push(document.getElementById("modButtonID"+i).innerHTML);
                }
                let response = await window.pywebview.api.restoreSelectedMods(buttonStates);
                i2 = 0
                for(let i = 0; i < response.length;) {
                    if(buttonStates[i+i2] == "||On||") {
                        document.getElementById("modStatusID" + (i+i2)).textContent = response[i];
                        i++;
                    }
                    else {
                        i2++;
                    }
                }
            }
            async function submitGameDir() {
                await window.pywebview.api.submitGameDir(document.getElementById('gameDirInput').value);
            }
            async function updateAllMods() {
                await window.pywebview.api.updateAllMods();
            }
            async function patchAllMods() {
                await window.pywebview.api.patchAllMods();
            }
            async function deleteTranslations() {
                await window.pywebview.api.deleteTranslations();
            }
            async function deleteAllModData() {
                await window.pywebview.api.deleteAllModData()
            }
            async function deleteModName() {
                await window.pywebview.api.resetModName(currentMod);
            }
        </script>
    </head>
    <body>
        <div id="topBar">
            <p id="titleText"> ||Yet Another Blue Archive Mod Manager|| </p>
        </div>
        <div id="buttonsDiv">
            <div>
                <input class="modFolderInput" id="modFolderInput" value="mod\\" placeholder="||Click the open button to open a mod!||">
                <button id="openButton" onclick="selectFolder()">||Open||</button>
            </div>

            <div id="line"></div>
            <p id="loadedText"> ||No Mods Loaded|| </p>
            
            <div>
                <button style="top:3vh" id="openButton" onclick="loadUserMods()">||Refresh||</button>
                <button style="top:3vh" id="openButton" onclick="applyUserMods()">||Apply||</button>
                <button style="top:3vh" id="openButton" onclick="restoreUserMods()">||Restore||</button>
                <button style="top:3vh" id="openButton" onclick="document.getElementById('dim3').style.display='flex'">||Settings||</button>
            </div>
            <p style="font-size: 2.3vh;" id="loadedText"> v0.1b2 - ||Made by Kalina|| </p>
            <p style="font-size: 1.7vh;" id="loadedText"> ||Please remove all mods from Steam client before using, they may break patching, updating mods, and backups.||</p>

        </div>

        <div id="logsDiv" class="styled-scrollbars"> </div>

        <div id="mainModListDiv" class="styled-scrollbars dropzone">
            <p class="nameChangeText" id="characterNameText"> ||Drag a mod to this window add it!|| </p>
        </div>


        <div class="dim" id="dim2" style="display: none">
            <div id="nameChanger" style="position: relative; top: 10vh;">
                <p class="nameChangeText" id="characterNameText" style="font-weight: bold;"> azusa my beloved </p>
                <p class="nameChangeText" id="realCharacterNameText"> ||Character: ||azusa_swimsuit_home </p>
                <p class="nameChangeText" id="isPrologdepengroupText"> Is Applied: False </p>

                <div class="modal-button-row top-row">
                    <button style="width:24%; height:15%" class="modal-button" onclick="openRenameMenu(currentMod)">||Rename||</button>
                    <button style="width:22%; height:15%" class="modal-button" onclick="reset()">||Reset||</button>
                    <button style="width:22%; height:15%" class="modal-button" onclick="deleteMod()">||Delete||</button>
                    <button style="width:22%; height:15%" class="modal-button" onclick="closeProperties()">||Cancel||</button>
                </div>
                <div class="modal-button-row bottom-row">
                    <button style="width:40%; height:15%" class="modal-button large-button" onclick="patchCRC()">||Patch CRC||</button>
                    <button style="width:40%; height:15%" class="modal-button large-button" onclick="updateMod()">||Update Mod||</button>
                </div>
                </div>
        </div>

        <div class="dim" id="dim" style="display: none;">
            <div id="nameChanger" class="rename-modal"> 
                <p id="nameChangeText" class="nameChangeText"> ||Enter a new mod name|| </p>
                
                <input id="nameChangeInput" placeholder="||Enter a new mod name||" maxlength="20">
                
                <div class="button-row rename-buttons">
                    <button onclick="applyModChange()">||Apply||</button>
                    <button onclick="cancelRenameMod()">||Cancel||</button>
                </div>
            </div>
        </div>

        <div class="dim" id="dim3" style="display: none;">
            <div id="nameChanger" style="position: relative; top: 30vh;"> 
                <p class="nameChangeText modal-title" style="font-weight: bold;">||Settings||</p>
                
                <div id="line" style="top:0vh"></div> 

                <div class="settings-group game-dir-group">
                    <p class="nameChangeText group-title" style="font-weight: initial"> ||Game Directory|| </p>
                    
                    <div class="input-button-row">
                        <input id="gameDirInput" class="modFolderInput" value="-defaultGameDir-" placeholder="Default Game Directory">
                        <button onclick="selectFolderGameDir()">||Open||</button>
                    </div>
                    
                    <div class="button-row game-dir-buttons">
                        <button onclick="resetGameDir()">||Reset||</button>
                        <button onclick="submitGameDir()">||Submit||</button>
                    </div>
                </div>
                
                <div id="line" style="top:1.5vh"></div> 

                <div class="settings-group action-group">
                    <div class="button-row two-col-row">
                        <button onclick="updateAllMods()">||Update all mods||</button>
                        <button onclick="patchAllMods()">||Patch all mods||</button>
                    </div>
                    <div class="button-row two-col-row">
                        <button style="height:20%" onclick="deleteTranslations()">||Delete translations||</button>
                        <button style="height:20%" onclick="deleteAllModData()">||Reset mod manager||</button>
                    </div>
                </div>
                
                <div class="settings-group close-group">
                    <button onclick="document.getElementById('dim3').style.display='none'">||Close||</button>
                </div>
            </div>
        </div>
    </body>
</html>